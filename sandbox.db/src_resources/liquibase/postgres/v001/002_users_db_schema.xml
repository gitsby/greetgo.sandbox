<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="arpanetus" id="create-db-schema">
        <sql endDelimiter=";;"><![CDATA[
        create table charm (
            id serial primary key,
            name varchar(255) not null,
            description varchar(255) not null,
            energy float
        );

        create table client (
            id serial primary key,
            surname varchar(255) not null,
            name varchar(255) not null,
            patronymic varchar(255),
            gender char(6) not null,
            birth_date  Date not null,
            charm integer not null references charm(id) on delete cascade
        );

        create table phone (
            number varchar(11),
            type varchar(6),
            client int not null references client(id) on delete cascade
        );



        create table client_addr (
            type varchar(4),
            street varchar(255),
            house varchar(255),
            flat varchar(255),
            client  int not null references client(id) on delete cascade
        );

        create table client_account (
            id serial primary key,
            number varchar(255),
            money float,
            registered_at timestamp,
            client int not null references client(id) on delete cascade
        );

        create table transaction_type (
            id serial primary key,
            code varchar(255),
            name varchar(255)
        );

        create table client_account_transaction (
            id serial primary key,
            account int not null references client_account(id),
            money float,
            finished_at timestamp not null,
            type int references transaction_type(id)
        );





    ]]></sql>
    <!--select client.id as id, concat_ws(' ', client.name::text, client.surname::text, client.patronymic::text) as fullName,
           cast(extract(epoch from client.birthDate) as integer) as age,
           max(client_account.money) as max, min(client_account.money) as min, sum(client_account.money) as total, charm.name as charm
        FROM client, client_account, charm
        WHERE client.id = client_account.client AND client.charm = charm.id
        GROUP BY client.id, charm.name;-->
    </changeSet>
    <changeSet id="create-get-table-function" author="arpanetus">
        <sql endDelimiter=";;"><![CDATA[
        create function table_to_view(limitNum int, skip int, sortType varchar(255), sortDirection varchar(255), filter varchar(255), filterType varchar(255))
        returns table(id int, fullName text, age integer, charm varchar(255), totalBalance int,minBalance int, maxBalance int)
        as select id, fullName, age, charm, totalBalance, minBalance, maxBalance from (
           select client.id as id, concat_ws(' ', client.name::text, client.surname::text, client.patronymic::text) as fullName,
           cast(extract(epoch from client.birthDate) as integer) as age,
           max(client_account.money) as max, min(client_account.money) as min, sum(client_account.money) as total, charm.name as charm
            from client, client_account, charm
            where client.id = client_account.client AND client.charm = charm.id)
           order by
           case sortType
                when 'fullName' then fullName
                when 'age' then age
                when 'totalBalance' then totalBalance
                when 'minBalance' then minBalance
                when 'maxBalance' then maxBalance
                else fullName
                end
           case sortDirection
                when 'desc' then DESC
                else ASC
           end
           limit limitNum offset skip
        ]]>

        </sql>
    </changeSet>
</databaseChangeLog>

